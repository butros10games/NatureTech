{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="{% static 'css/boer-admin/orders/admin_orders.css' %}" />
  </head>
  <body>
    {% include 'boer-admin/overlays/navbar.html' %}
    <table id="booking-table">
      <thead>
        <tr>
          <th data-sort="order_number" data-order="asc">Order Nummer</th>
          <th data-sort="lastname" data-order="asc">Naam</th>
          <th data-sort="start_date" data-order="asc">CheckIn datum</th>
          <th data-sort="end_date" data-order="asc">CheckOut datum</th>
          <th data-sort="actions" data-order="asc">Acties</th>
        </tr>
      </thead>
      <tbody id="table_content">
        {% for booking in page_obj %}
          <tr>
            <td>{{ booking.order_number }}</td>
            <td>{{ booking.customer.user.first_name }} {{ booking.customer.user.last_name }}</td>
            <td>{{ booking.start_date }}</td>
            <td>{{ booking.end_date }}</td>
            <td>
              <span><a class="ajax-link modal-trigger" data-modal-id="modal_{{ booking.id }}">bewerken</a></span>
          </td>          
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="pagination">
      <span class="step-links"><a id="prev" pageNumber="1" class="ajax-link">Vorige</a></span>

      <span class="current">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

      <span class="step-links"><a id="next" pageNumber="1" class="ajax-link">Volgende</a></span>
    </div>
    <div class="modal" id="modal_{{ booking.id }}">
      <div class="modal-content">
        <span class="close" id="close{{ booking.id }}">&times;</span>
        <p>Naam: {{ booking.customer.user.first_name }} {{ booking.customer.user.last_name }}</p>
        <p>Telefoon nummer: {{ booking.customer.phone_number }}</p>
        <p>Email: {{ booking.customer.user.email }}</p>
        <p>Adres: {{ booking.customer.address }}</p>
        <p>Postcode: {{ booking.customer.postal_code }}</p>
        <p>Woonplaats: {{ booking.customer.city }}</p>
      </div>
  </body>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
    
      // Call the initial data load with default sorting
      request_data(1);
  
      // Add click events to the table headers for sorting
      const tableHeaders = document.querySelectorAll('#booking-table th[data-sort]');
      tableHeaders.forEach((header) => {
          header.addEventListener('click', function () {
              const currentSortOrder = header.getAttribute('data-order');
              const newSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
              const sortBy = header.getAttribute('data-sort');
      
              // Set the new sort order
              header.setAttribute('data-order', newSortOrder);
  
              // Request data with sorting parameters
              sort_data(sortBy, newSortOrder);
          });
      });
    
      //add click events to the bewerken buttons for loading the modal
      const modalTriggers = document.querySelectorAll('.modal-trigger');
      modalTriggers.forEach((trigger) => {
          trigger.addEventListener('click', function () {
              const modalId = trigger.getAttribute('data-modal-id');
              const modal = document.getElementById(modalId);
              console.log(modalId);
  
              // Display the modal
              modal.style.display = 'block';
  
              // Request the modal data
              requestModalData(modalId);
  
              // Close the modal when the user clicks outside of it
              window.onclick = function (event) {
                  if (event.target == modal) {
                      modal.style.display = 'none';
                  }
              };
  
              // Close the modal when the user clicks on the close button
              const close = document.getElementById('close' + modalId.split('_')[1]);
              close.addEventListener('click', function () {
                  modal.style.display = 'none';
              });
          });
      });

    
      const prevButton = document.getElementById('prev')
      const nextButton = document.getElementById('next')
      const tableContent = document.getElementById('table_content')
    
      // Add click event to the prev button
      prevButton.addEventListener('click', function () {
        console.log('clicked')
    
        // Get the page number
        let pageNumber = parseInt(this.getAttribute('pageNumber'))
    
        // If the page number is 0, then we are on the first page
        if (pageNumber === 1) {
          // Disable the prev button
          this.classList.add('disabled')
        } else {
          // Enable the next button
          nextButton.classList.remove('disabled')
    
          // Get the previous page number
          let prevPageNumber = pageNumber - 1
    
          // Set the page number
          this.setAttribute('pageNumber', prevPageNumber)
          nextButton.setAttribute('pageNumber', prevPageNumber)
    
          request_data(prevPageNumber)
        }
      })
    
      // Add click event to the next button
      nextButton.addEventListener('click', function () {
        console.log('clicked')
    
        // Get the page number
        let pageNumber = parseInt(this.getAttribute('pageNumber'))
    
        // Enable the next button
        nextButton.classList.remove('disabled')
    
        // Get the next page number
        let nextPageNumber = pageNumber + 1
    
        // Set the page number
        this.setAttribute('pageNumber', nextPageNumber)
        prevButton.setAttribute('pageNumber', nextPageNumber)
    
        request_data(nextPageNumber)
      })



      //Function to request data of the modal
      function requestModalData(modalId) {
        // Get the URL
        let url = '/create_modal/';

        const data = {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          id: modalId,

        }
      
        $.ajax({
          type: 'POST',
          url: url,
          data: data,
          success: function fill_modal(data) {
            // Fill the table
            fill_modal(data);
          },
          error: function (data) {
            console.log(data);
          },
        });
      }
    
      function request_data(pageNumber) {
        // Get the URL
        let url = window.location.href
    
        const data = {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          page: pageNumber,
        }
  
        $.ajax({
          type: 'POST',
          url: url,
          data: data,
          success: function (data) {
    
            // Fill the table
            fill_table(data)
          },
          error: function (data) {
            console.log(data)
          }
        }) 
      }
	  function sort_data(sortBy, sortOrder) {
        let url = '/sort_bookings/'
    
        const data = {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          sort_by: sortBy,
          order: sortOrder,
        }
		console.log(data);
    
        $.ajax({
          type: 'POST',
          url: url,
          data: data,
          success: function (data) {
			console.log(data);
            // Fill the table with sorted data
            fill_table(data)
          },
          error: function (data) {
            console.log(data)
          }
        })
      }
    
      function fill_table(datas) {
        // Clear the table
        tableContent.innerHTML = ''
    
        // Loop through the data
        for (let i = 0; i < datas.length; i++) {
          field = datas[i]
          // Create a new row
          let row = document.createElement('tr')
    
          // Create the columns
          let checkInDate = document.createElement('td')
          let orderNumber = document.createElement('td')
          let name = document.createElement('td')
          let checkOutDate = document.createElement('td')
          let actions = document.createElement('td')
    
          // Set the text of the columns
          orderNumber.innerText = field.order_number
          name.innerText = field.firstname + ' ' + field.lastname
          checkInDate.innerText = field.start_date
          checkOutDate.innerText = field.end_date
          actions.innerHTML = '<span><a class="ajax-link modal-trigger" data-modal-id="modal_' + field.id + '">bewerken</a></span>'

    
          // Append the columns to the row
          row.appendChild(orderNumber)
          row.appendChild(name)
          row.appendChild(checkInDate)
          row.appendChild(checkOutDate)
          row.appendChild(actions)
    
          // Append the row to the table
          tableContent.appendChild(row)
        }
      }
      
    
    })
  </script>
</html>
